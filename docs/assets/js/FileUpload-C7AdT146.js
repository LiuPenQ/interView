import{An as n,Ct as v,Dn as N,Dt as ie,En as A,Ft as ne,Jt as J,Kt as ue,Lt as c,Pt as de,Qt as i,St as f,Tt as ve,bt as a,ht as L,ot as V,ut as ce,vt as W,wt as pe,yt as j,zt as R}from"./index-BtMNP6xD.js";var me={class:"file-upload-container p-6 relative"},be={class:"flex justify-between items-center mb-6"},fe={class:"relative"},ge={class:"file-selector mb-8"},_e={class:"flex items-center gap-4"},he=["disabled"],ye={class:"file-info flex-1"},xe={class:"file-name"},we={class:"file-size text-sm",style:{color:"var(--color-text-secondary)"}},Me={key:0,class:"text-sm",style:{color:"var(--color-text-secondary)"}},Ce={key:0,class:"error-message mt-4 p-3 rounded-md",style:{"background-color":"rgba(239, 68, 68, 0.1)",color:"#ef4444"}},$e={class:"upload-settings mb-8"},ze={class:"form-group"},ke={class:"flex items-center gap-4"},Be=["disabled"],Fe={class:"form-group mt-6"},Se={class:"flex items-center gap-4"},Ue=["disabled"],Te={class:"form-group mt-4"},Ie={class:"text-sm"},Pe={key:0},De={class:"upload-status mb-8"},Ne={class:"status-card p-4 rounded-lg"},Ve={class:"status-item mb-2"},je={class:"status-item mb-2"},Ee={class:"status-value"},Ge={class:"status-item mb-2"},He={class:"status-value"},Ke={class:"status-item mb-2"},Qe={class:"status-value"},Ae={class:"status-item"},Je={class:"status-value"},Le={class:"memory-monitor mb-8"},We={class:"memory-chart p-4 rounded-lg",style:{"background-color":"var(--color-bg-secondary)"}},Re={class:"memory-grid",style:{height:"100px",width:"100%",position:"relative"}},qe={class:"memory-stats mt-2 flex justify-between text-sm"},Oe={key:0},Xe={class:"upload-progress mb-8"},Ye={class:"progress-bar bg-gray-200 rounded-full h-4 overflow-hidden"},Ze={class:"chunks-info mb-8"},ea={class:"flex justify-between items-center mb-4"},aa=["disabled"],ta={class:"form-group mb-4"},la={class:"text-sm"},sa={key:0,class:"chunks-container overflow-auto max-h-60"},oa={class:"chunks-grid grid grid-cols-20 gap-1"},ra=["title"],ia={key:1,class:"text-center py-4",style:{"background-color":"var(--color-bg-secondary)","border-radius":"var(--radius-md)"}},na={class:"upload-controls"},ua={class:"flex gap-4"},da=["disabled"],va=["disabled"],ca=["disabled"],pa=["disabled"],ma=["disabled"],E=60,ba=ie({__name:"FileUpload",setup(fa){const o=i(null),G=i(null),s=i("idle"),g=i(0),w=i(0),d=i([]),p=i(1024*1024*5),_=i(3),h=i(new Set),M=i(0),k=i(0),H=i(1024*1024*1500),m=i(""),C=i(!1),y=i(0),B=i([]),F=i(!1),S=i(!1),U=i(new Set),q=()=>"memory"in performance?performance:null,b=i([]),T=j(()=>o.value?Math.ceil(o.value.size/p.value):0),O=j(()=>{var l;return((l=o.value)===null||l===void 0?void 0:l.name)||"未选择文件"}),X=j(()=>{if(!o.value)return"0 B";const l=o.value.size;return l<1024?`${l} B`:l<1024*1024?`${(l/1024).toFixed(2)} KB`:l<1024*1024*1024?`${(l/(1024*1024)).toFixed(2)} MB`:`${(l/(1024*1024*1024)).toFixed(2)} GB`}),Y=l=>{const e=l.target;if(e.files&&e.files[0]){const t=e.files[0];if(t.size>H.value){m.value=`文件大小超过限制（最大 ${H.value/(1024*1024)}MB）`,s.value="error";return}m.value="",o.value=t,I(),P()}},I=()=>{s.value="idle",g.value=0,w.value=0,d.value=[],h.value=new Set,M.value=0,k.value=0,m.value="",y.value=0,U.value=new Set},P=()=>{if(!o.value)return;d.value=[],B.value=[];const l=o.value.size;let e=0,t=0;const r=o.value.size>1024*1024*200?Math.max(p.value,1024*1024*10):p.value,u=Math.max(r,Math.ceil(l/2e3));for(;e<l;){const x=Math.min(e+u,l),$=x-e,z={index:t,start:e,end:x,size:$,uploaded:!1,error:!1};d.value.push(z),B.value.push(z),e=x,t++}y.value=Math.min(d.value.length*u/(1024*1024),500),console.log(`文件分片完成: ${d.value.length}个分片，每个分片${(u/1024/1024).toFixed(2)}MB`)},Z=l=>{if(!o.value)throw new Error("No file selected");return l.blob||(l.blob=o.value.slice(l.start,l.end)),l.blob},ee=(function(){var l=V(function*(e){try{if(U.value.has(e.index))return console.log(`分片 ${e.index+1} 已存在，秒传`),!0;Z(e);const t=Math.min(500,Math.max(100,e.size/1024/1024*100));return yield new Promise(r=>setTimeout(r,t)),console.log(`上传分片 ${e.index+1}/${T.value} (${(e.size/1024/1024).toFixed(2)}MB)`),e.blob=void 0,U.value.add(e.index),!0}catch(t){return console.error("分片上传失败:",t),!1}});return function(t){return l.apply(this,arguments)}})(),ae=(function(){var l=V(function*(e,t){try{if(y.value>100&&(yield new Promise(r=>setTimeout(r,500))),yield ee(e)){e.uploaded=!0,e.error=!1,h.value.add(e.index),w.value=e.index+1;const r=Array.from(h.value).reduce(($,z)=>{const Q=d.value[z];return $+(Q?Q.size:0)},0);g.value=Math.round(r/o.value.size*100);const u=(Date.now()-t)/1e3;M.value=Math.round(r/u/1024);const x=o.value.size-r;if(k.value=Math.round(x/Math.max(1,M.value*1024)),(e.index+1)%5===0&&typeof window.gc=="function")try{window.gc()}catch($){}return!0}else return e.error=!0,!1}catch(r){return console.error("处理分片失败:",r),e.error=!0,!1}});return function(t,r){return l.apply(this,arguments)}})(),K=(function(){var l=V(function*(){if(!o.value||s.value==="uploading"||F.value)return;s.value="uploading",m.value="",F.value=!0;const e=Date.now();try{const t=[...B.value.filter(r=>!h.value.has(r.index)&&!r.error)];for(console.log(`开始上传: ${t.length}个分片待上传，并发数: ${_.value}`);t.length>0&&s.value==="uploading";){const r=t.splice(0,_.value);if(console.log(`处理批次: ${r.map(u=>u.index+1).join(", ")}`),!(yield Promise.all(r.map(u=>ae(u,e)))).every(u=>u))throw new Error("批次上传失败");yield new Promise(u=>setTimeout(u,100))}s.value==="uploading"&&g.value===100&&(s.value="completed",console.log("上传完成！"))}catch(t){console.error("上传失败:",t),m.value=t.message||"上传失败，请重试",s.value="error"}finally{F.value=!1}});return function(){return l.apply(this,arguments)}})(),te=()=>{s.value==="uploading"&&(s.value="paused")},le=()=>{s.value==="paused"&&K()},se=()=>{I(),o.value&&P()},oe=()=>{var l;(l=G.value)===null||l===void 0||l.click()},re=()=>{I(),o.value=null};let D=null;return ue(p,()=>{o.value&&s.value==="idle"&&P()},{immediate:!1}),de(()=>{D=window.setInterval(()=>{const l=q();l&&(b.value.push(l.memory.usedJSHeapSize),b.value.length>E&&b.value.shift())},1e3)}),ne(()=>{D&&clearInterval(D)}),(l,e)=>(c(),v("div",me,[a("div",be,[e[7]||(e[7]=a("h1",{class:"text-xl font-bold"},"大文件上传研究",-1)),a("div",fe,[a("button",{class:"tech-info-btn",onMouseenter:e[0]||(e[0]=t=>S.value=!0),title:"显示技术说明"},[...e[5]||(e[5]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)])],32),S.value?(c(),v("div",{key:0,class:"tech-info-popover",onMouseleave:e[1]||(e[1]=t=>S.value=!1)},[...e[6]||(e[6]=[pe('<div class="tech-info-content" data-v-2c618bea><h2 class="text-lg font-semibold mb-2" data-v-2c618bea>技术说明</h2><div class="space-y-2" data-v-2c618bea><p data-v-2c618bea><strong data-v-2c618bea>分片上传:</strong> 将大文件分割成多个小块（分片），逐个上传，降低单个请求的大小和失败率。</p><p data-v-2c618bea><strong data-v-2c618bea>断点续传:</strong> 记录已上传的分片，支持从失败或暂停的地方继续上传，不需要重新上传整个文件。</p><p data-v-2c618bea><strong data-v-2c618bea>内存优化:</strong> 针对大文件上传进行了内存使用优化，避免页面崩溃。</p><p data-v-2c618bea><strong data-v-2c618bea>实现原理:</strong></p><ul class="list-disc pl-6 space-y-1" data-v-2c618bea><li data-v-2c618bea>使用 File.slice() 方法分割文件</li><li data-v-2c618bea>延迟创建分片的 Blob 对象，避免一次性占用过多内存</li><li data-v-2c618bea>上传完成后释放 Blob 对象占用的内存</li><li data-v-2c618bea>限制最大文件大小（1.5GB）和最大分片数（2000个）</li><li data-v-2c618bea>记录已上传的分片索引，支持断点续传</li><li data-v-2c618bea>支持暂停和恢复上传</li><li data-v-2c618bea>计算上传进度、速度和剩余时间</li><li data-v-2c618bea>模拟网络错误和重试机制</li><li data-v-2c618bea>定期触发垃圾回收（如果浏览器支持）</li></ul><p data-v-2c618bea><strong data-v-2c618bea>性能建议:</strong></p><ul class="list-disc pl-6 space-y-1" data-v-2c618bea><li data-v-2c618bea>对于大文件，建议使用10-20MB的分片大小</li><li data-v-2c618bea>避免同时上传多个大文件</li><li data-v-2c618bea>如果遇到内存使用过高的错误，尝试增大分片大小</li><li data-v-2c618bea>对于特别大的文件，考虑使用专业的文件上传服务</li></ul></div></div>',1)])],32)):f("",!0)])]),a("div",ge,[e[8]||(e[8]=a("h2",{class:"text-xl font-semibold mb-4"},"文件选择",-1)),a("div",_e,[a("input",{ref_key:"fileInput",ref:G,type:"file",class:"hidden",onChange:Y},null,544),a("button",{class:"btn btn-primary",onClick:oe,disabled:s.value==="uploading"}," 选择文件 ",8,he),a("div",ye,[a("p",xe,n(O.value),1),a("p",we,n(X.value),1),y.value>0?(c(),v("p",Me," 预估内存使用: "+n(y.value.toFixed(2))+" MB ",1)):f("",!0)])]),m.value?(c(),v("div",Ce,n(m.value),1)):f("",!0)]),a("div",$e,[e[13]||(e[13]=a("h2",{class:"text-xl font-semibold mb-4"},"上传设置",-1)),a("div",ze,[e[9]||(e[9]=a("label",{class:"form-label"},"分片大小",-1)),a("div",ke,[J(a("input",{type:"range","onUpdate:modelValue":e[2]||(e[2]=t=>p.value=t),min:1024*1024,max:20*1024*1024,step:1024*1024,disabled:s.value==="uploading"},null,8,Be),[[L,p.value,void 0,{number:!0}]]),a("span",null,n(p.value/(1024*1024))+" MB",1)]),e[10]||(e[10]=a("p",{class:"text-sm mt-2",style:{color:"var(--color-text-secondary)"}}," 提示：对于大文件，建议使用10-20MB的分片大小 ",-1))]),a("div",Fe,[e[11]||(e[11]=a("label",{class:"form-label"},"并发控制",-1)),a("div",Se,[J(a("input",{type:"range","onUpdate:modelValue":e[3]||(e[3]=t=>_.value=t),min:1,max:10,step:1,disabled:s.value==="uploading"},null,8,Ue),[[L,_.value,void 0,{number:!0}]]),a("span",null,n(_.value)+" 个并发",1)]),e[12]||(e[12]=a("p",{class:"text-sm mt-2",style:{color:"var(--color-text-secondary)"}}," 提示：默认3个并发，防止把后端打崩 ",-1))]),a("div",Te,[a("p",Ie,[ve(" 总分片数: "+n(T.value)+" ",1),o.value?(c(),v("span",Pe," ("+n(p.value)+" bytes 每片)",1)):f("",!0)])])]),a("div",De,[e[19]||(e[19]=a("h2",{class:"text-xl font-semibold mb-4"},"上传状态",-1)),a("div",Ne,[a("div",Ve,[e[14]||(e[14]=a("span",{class:"status-label"},"状态:",-1)),a("span",{class:A(["status-value",{"text-green-500":s.value==="completed","text-blue-500":s.value==="uploading","text-yellow-500":s.value==="paused","text-red-500":s.value==="error"}])},n({idle:"就绪",uploading:"上传中",paused:"已暂停",completed:"已完成",error:"上传失败"}[s.value]),3)]),a("div",je,[e[15]||(e[15]=a("span",{class:"status-label"},"进度:",-1)),a("span",Ee,n(g.value)+"%",1)]),a("div",Ge,[e[16]||(e[16]=a("span",{class:"status-label"},"当前分片:",-1)),a("span",He,n(w.value)+"/"+n(T.value),1)]),a("div",Ke,[e[17]||(e[17]=a("span",{class:"status-label"},"上传速度:",-1)),a("span",Qe,n(M.value)+" KB/s",1)]),a("div",Ae,[e[18]||(e[18]=a("span",{class:"status-label"},"预计剩余时间:",-1)),a("span",Je,n(k.value)+" 秒",1)])])]),a("div",Le,[e[21]||(e[21]=a("h2",{class:"text-xl font-semibold mb-4"},"内存监控",-1)),a("div",We,[a("div",Re,[(c(!0),v(W,null,R(b.value,(t,r)=>(c(),v("div",{key:r,class:"memory-bar",style:N({position:"absolute",bottom:"0",left:`${r/(E-1)*100}%`,width:`${100/E}%`,height:`${Math.min(100,t/104857600*100)}%`,backgroundColor:"var(--color-primary)",opacity:"0.7",borderRadius:"2px 2px 0 0",transition:"height 0.3s ease"})},null,4))),128))]),a("div",qe,[e[20]||(e[20]=a("span",null,"内存使用趋势 (最近60秒)",-1)),b.value.length>0?(c(),v("span",Oe," 当前: "+n(((b.value[b.value.length-1]||0)/1048576).toFixed(2))+" MB ",1)):f("",!0)])])]),a("div",Xe,[a("div",Ye,[a("div",{class:A(["progress-fill h-full rounded-full transition-all duration-300",{"bg-blue-500":s.value==="uploading","bg-green-500":s.value==="completed","bg-yellow-500":s.value==="paused","bg-red-500":s.value==="error"}]),style:N({width:`${g.value}%`})},null,6)])]),a("div",Ze,[a("div",ea,[e[22]||(e[22]=a("h2",{class:"text-xl font-semibold"},"分片信息",-1)),a("button",{class:"btn btn-secondary btn-sm",onClick:e[4]||(e[4]=t=>C.value=!C.value),disabled:d.value.length===0},n(C.value?"隐藏详情":"显示详情"),9,aa)]),a("div",ta,[a("p",la," 总分片数: "+n(d.value.length)+" | 已上传: "+n(h.value.size)+" | 失败: "+n(d.value.filter(t=>t.error).length),1)]),C.value&&d.value.length>0?(c(),v("div",sa,[a("div",oa,[(c(!0),v(W,null,R(d.value,t=>(c(),v("div",{key:t.index,class:"chunk-item w-3 h-3 rounded-full transition-all",style:N({backgroundColor:!t.uploaded&&!t.error?"var(--color-bg-tertiary)":t.uploaded?"var(--color-primary)":"var(--color-border)",boxShadow:t.index===w.value-1?"0 0 0 2px var(--color-primary)":"none"}),title:`分片 ${t.index+1}: ${(t.size/1024/1024).toFixed(2)}MB`},null,12,ra))),128))])])):d.value.length>0?(c(),v("div",ia,[...e[23]||(e[23]=[a("p",{class:"text-sm",style:{color:"var(--color-text-secondary)"}},' 分片详情已隐藏，点击"显示详情"按钮查看 ',-1)])])):f("",!0)]),a("div",na,[e[24]||(e[24]=a("h2",{class:"text-xl font-semibold mb-4"},"控制",-1)),a("div",ua,[a("button",{class:"btn btn-primary",onClick:K,disabled:!o.value||s.value==="uploading"||s.value==="completed"}," 开始上传 ",8,da),a("button",{class:"btn btn-secondary",onClick:te,disabled:s.value!=="uploading"}," 暂停 ",8,va),a("button",{class:"btn btn-secondary",onClick:le,disabled:s.value!=="paused"}," 恢复 ",8,ca),a("button",{class:"btn btn-danger",onClick:se,disabled:!o.value}," 重新上传 ",8,pa),a("button",{class:"btn btn-danger",onClick:re,disabled:!o.value}," 取消 ",8,ma)])])]))}}),_a=ce(ba,[["__scopeId","data-v-2c618bea"]]);export{_a as default};
